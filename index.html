<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AVA</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 24px;
        background: #fff;
      }
      .card {
        max-width: 720px;
        padding: 18px;
        border: 1px solid #ddd;
        border-radius: 12px;
      }
      code {
        background: #f3f3f3;
        padding: 2px 6px;
        border-radius: 6px;
      }
      small {
        color: #555;
      }
      .debug {
        margin-top: 12px;
        font-size: 12px;
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 10px;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>AVA rodando ✅</h1>
      <p>Teste de conexão com o Supabase:</p>

      <div id="status">Carregando...</div>

      <div id="debug" class="debug">Logs:\n</div>

      <hr />
      <small>Se der erro, ele aparece aqui e também no Console (F12).</small>
    </div>

    <script type="module">
      const statusEl = document.getElementById('status');
      const debugEl = document.getElementById('debug');

      function log(msg) {
        debugEl.textContent += msg + '\n';
        console.log(msg);
      }

      function setStatus(html) {
        statusEl.innerHTML = html;
      }

      // Sempre troca o "Carregando..." logo de cara:
      const now = new Date().toLocaleString('pt-BR');
      setStatus(`⏳ Inicializando... <small>(JS carregou em ${now})</small>`);
      log(`[BOOT] JS carregou em ${now}`);

      try {
        log('[1/3] Importando supabaseClient.js ...');

        // IMPORT RELATIVO (funciona no GitHub Pages /AVA3/)
        const mod = await import('./assets/js/supabaseClient.js');

        log('[2/3] Import OK. Testando conexão com o Supabase...');

        // Teste real (faz request)
        const url = `${mod.supabaseUrl()}/auth/v1/health`;
        log(`[PING] GET ${url}`);

        const res = await fetch(url, {
          method: 'GET',
          headers: {
            apikey: mod.supabaseAnonKey(),
            Authorization: `Bearer ${mod.supabaseAnonKey()}`,
          },
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => '');
          setStatus(
            `❌ Não conectou. HTTP <code>${res.status}</code> <br><small>${
              txt || 'Sem corpo de resposta'
            }</small>`
          );
          log(`[ERRO] HTTP ${res.status} - ${txt}`);
        } else {
          const data = await res.json().catch(() => ({}));
          setStatus(
            `✅ Conectado ao Supabase! <small>(health: ${JSON.stringify(
              data
            )})</small>`
          );
          log('[OK] Conectado ao Supabase.');
        }
      } catch (e) {
        setStatus(
          `❌ Erro ao carregar/testar Supabase: <code>${e?.message || e}</code>`
        );
        log(`[EXCEPTION] ${e?.stack || e?.message || e}`);
      }
    </script>
  </body>
</html>
